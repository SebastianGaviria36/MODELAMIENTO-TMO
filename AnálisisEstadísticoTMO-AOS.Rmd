---
title: "Análisis-TMO&AOS"
author: "Sebastian Gaviria Sánchez"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
library(readxl)
library(dplyr)
library(lubridate)
library(knitr)
library(ggfortify)
library(plotly)
library(survival)
library(ggpubr)
library(caret)
```

```{r}
#cargando la base de datos
datos <- read_excel("BD 6 MARZO 2023.xlsx")

#completando fecha de inicio
for (i in 1:nrow(datos)){
  if(is.na(datos$inicio[i])){
    datos$inicio[i] <- datos$inicio[i-1]
  }
}

#arreglando fecha fin
datos$fin <- substr(datos$fin,1,10)
datos$fin <- as.POSIXlt.character(datos$fin, tz = "UTC", format = "%d/%m/%Y")

#Quitando los cancelados
datos <- datos %>% filter(estado == "Completado")

#Calculando días
datos$dias <- difftime(datos$fin,
                       datos$inicio, 
                       units = "days") %>%
  as.numeric()
```

## Estadísticos de resumen

Se tiene gran interés en responder los siguientes cuestionamientos:

-   ¿Cuánto se demora en promedio un paciente para completar cada nivel?
-   ¿Cuánto se demora en promedio un paciente para terminar el tratamiento?

Para dar respuesta a la primera pregunta se muestra la siguiente tabla

```{r}
df_dias_promedio <- datos %>%
                    group_by(nivel) %>%
                    summarise_at(vars(dias), list(días_promedio = mean))

kable(df_dias_promedio, caption = "Días promedio por nivel del tratamiento", align = "c",
      booktab = T, escape = F, col.names = c("Nivel", "Días promedio"), digits = 1)
```

Con esta última se tienen las siguientes conclusiones:

-   En promedio, los pacientes bajo el tratamiento tardan aproximadamente 21 días en completar el nivel 1 del mismo.

-   Así mismo, para el nivel 2 de dicho tratamiento, los pacientes tardan aproximadamente 15 días para completarlo en promedio.

-   Similar al nivel 1, en el nivel 3 los pacientes bajo el tratamiento tardan en promedio 20 días en completar el mismo.

-   Para el nivel 4, se puede decir que los pacientes en promedio se tardan 17 días en llegar al final de este nivel.

-   De manera análoga al nivel 3, en el nivel 5 los pacientes también tardan en promedio 20 días aproximadamente.

-   Finalmente y a diferencia de los demás niveles, en el nivel 6 los pacientes suelen tardar más en promedio, con casi 28 días para terminar este nivel.

Ahora, interesa conocer cuánto se demora un paciente en promedio para finalizar el tratamiento en su totalidad. Para esta causa se muestra el siguiente resumen. \newpage

```{r}
Datosdepurados <- read_excel("Datosdepurados.xlsx")
Datosdepurados$dias <- difftime(Datosdepurados$`Fecha Fin`,
                                Datosdepurados$`Fecha Incio`, 
                                units = "days") %>%
  as.numeric() %>% round(2)
resultsumm <- Datosdepurados %>% filter(!is.na(`TMO NIVEL 6`)) %>% 
  select(dias) %>% summary()

df_summary_tratcomp <- data.frame(Est = c('Mínimo','Percentil 25','Mediana',
                                          'Promedio','Percentil 75','Máximo'),
                                  Freq = c(86.0,124.2,150.5,157.8,181.0,328.0))

kable(df_summary_tratcomp, caption = "Días para terminar el tratamiento", 
      align = "c", booktab = T, escape = F, 
      col.names = c("Estadístico", "Resultado"), digits = 1)

```

Con este resultado se llega a las siguientes conclusiones:

-   El paciente que menos se demoró en terminar el tratamiento lo hizo en 86 días.

-   Según el percentil 25, se afirma que el 25% de los pacientes terminan en menos de 125 días.

-   Similarmente, según la mediana la mitad de los pacientes termina el tratamiento antes de los 150 días.

-   En promedio, los pacientes tardan 158 días en terminar el tratamiento.

-   Según el percentil 75, el 75% de los pacientes tarda menos de 181 días en terminar el tratamiento.

-   Finalmente, el paciente que más tardó en terminar su tratamiento lo hizo en 328 días.

## Curva de supervivencia

En aras de determinar el comportamiento de deserción a lo largo del tratamiento, se desea estimar la curva de supervivencia para observar la probabilidad de que un paciente continúe a partir de un día determinado en el tratamiento o de manera análoga, qué porción de la cohorte inicial va a continuar bajo tratamiento en un momento específico del mismo.

Así pues, se estima la curva de supervivencia $S(t) = P(T > t)$ usando el estimado de Kaplan-Meier. El resultado se ilustra a continuación:

```{r, warning=F}
#definiendo evento para km
Datosdepurados$evento <- ifelse(Datosdepurados$Status == "Evento", 1, 0)

#Estimando S(t) via kaplan-meier
KM_fit <- survfit(Surv(dias, evento) ~ 1, data = Datosdepurados)

#graficando S(t)

p <- autoplot(KM_fit, type="fill",surv.alpha=0.9, 
         surv.size=1.5,
         conf.int.alpha=0,
         censor.size=0,
         surv.colour="#666666")+ 
  labs(x = "\n Tiempo en el tratamiento (Días) ", 
       y = "Probabilidad de continuar \n", 
       title = "Curva de supervivencia estimada:\n TMO para pacientes con apnea del sueño",
       caption = "Usando el estimador de Kaplan-Meier") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10)) +
  geom_vline(xintercept = c(21,36,57,74,94,121), linetype="dashed", 
             color = "black", size=0.5) +
  xlim(0,125) +
  #ylim(50,100) +
  geom_label(aes(x=21, y = 1, label = "Nivel 1")) +
  geom_label(aes(x=36, y = 1, label = "Nivel 2")) +
  geom_label(aes(x=57, y = 1, label = "Nivel 3")) +
  geom_label(aes(x=74, y = 1, label = "Nivel 4")) +
  geom_label(aes(x=94, y = 1, label = "Nivel 5")) +
  geom_label(aes(x=121, y = 1, label = "Nivel 6")) +
  geom_label(aes(x=20, y = 0.4,
  label = "Probabilidad de que continúe\n a partir del nivel 1 es 84.2%")) +
  geom_segment(aes(x=0, xend=21,y=0.8421349,yend=0.8421349),
               linetype="dashed") +
  geom_segment(aes(x=21,xend=10,y=0.8421349, yend=0.5),
               arrow = arrow(length = unit(0.3,"cm")), size = 1, col = "red")

p
```

En este gráfico se considera que un paciente se va a demorar por nivel lo obtenido en la sección de estadísticos de resúmen, es decir, para el nivel 1 del tratamiento 21 días, para el nivel 2 15 días, para el nivel 3 20 días, para el nivel 4 17 días, para el nivel 5 20 días y para el nivel 6 28 días.

Así entonces, las líneas verticales punteadas demarcan el día esperado para que un paciente termine el nivel correspondiente que se señala en la parte superior.

Dicho esto, se tienen las siguientes conclusiones de interés:

-   Un paciente que termine el nivel 1 del tratamiento tendrá una probabilidad del 84.2% de continuar ea nivel 2 o de manera análoga, se espera que el 84.2% de los pacientes que comienzan el tratamiento continúen al nivel 2.

-   Similarmente, un paciente que termine el nivel 2 del tratamiento tendrá una probabilidad del 68.2% de continuar al nivel 3 o de manera análoga, se espera que el 68.2% de los pacientes que comienzan el tratamiento continúen al nivel 3.

-   De igual forma, un paciente que termine el nivel 3 del tratamiento tendrá una probabilidad del 50.2% de continuar al nivel 4 o de manera análoga, se espera que el 50.2% de los pacientes que comienzan el tratamiento continúen al nivel 4.

-   Así mismo, un paciente que termine el nivel 4 del tratamiento tendrá una probabilidad del 41.2% de continuar al nivel 5 o de manera análoga, se espera que el 41.2% de los pacientes que comienzan el tratamiento continúen al nivel 5.

-   Igualmente, un paciente que termine el nivel 5 del tratamiento tendrá una probabilidad del 34.4% de continuar al nivel 6 o de manera análoga, se espera que el 34.4% de los pacientes que comienzan el tratamiento continúen al nivel 6.

## Diferencia entre grupos de GAP

Una de las dinámicas del tratamiento consiste en programar una cita de control para cada paciente una vez termine uno de los niveles y esté a puertas de comenzar el siguiente; sin embargo estas citas de control en algunas ocasiones suelen programarse en un periodo prolongado, lo que ocasiona una ventana de tiempo considerablemente grande entre niveles del tratamiento. En este caso se considera que una ventana de tiempo mayor a 15 días entre niveles es excesivo e incluso posiblemente perjudicial para los efectos del tratamiento.

Con lo anterior se crea naturalmente el cuestionamiento: ¿Un GAP (ventana) de tiempo excesivo (mayor a quince días) entre niveles ocasiona que los pacientes bajo tratamiento se adhieran menos al mismo?

Para dar respuesta a esta pregunta se clasifican los pacientes de acuerdo a si en algún momento de su tratamiento tuvieron al menos un GAP de tiempo mayor a quince días en algún momento. Habitualemnte se crean dos grupos: Aquellos que tuvieron sus citas de control en menos de quince días (GAP $\leq$ 15) y aquellos que en algún momento del tratamiento tuvieron un tiempo de espera prolongado entre niveles del mismo (GAP \> 15). Así pues, para apreciar la adherencia de ambos grupos se grafican sus respectivas curvas de supervivencia como sigue.

```{r, warning=FALSE, fig.width=8.5}
KM_fit_2 <- survfit(Surv(dias, evento) ~ GAP, data = Datosdepurados)

p2 <- autoplot(KM_fit_2, type="fill",surv.alpha=0.9, 
               surv.size=2,
               conf.int.alpha=0.2,
               censor.size=5,
               censor.colour="purple")+ 
  labs(x = "\n Tiempo en el tratamiento (Días) ", 
       y = "Probabilidad de continuar \n", 
       title = "Curva de supervivencia estimada:\n TMO para pacientes con apnea del sueño",
       caption = "Usando el estimador de Kaplan-Meier",
       color = "Tiempo de espera\n entre niveles") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10)) +
  geom_vline(xintercept = c(21,36,57,74,94,121), linetype="dashed", 
             color = "black", size=0.5) +
  xlim(0,125) +
  geom_label(aes(x=21, y = 1, label = "Nivel 1")) +
  geom_label(aes(x=36, y = 1, label = "Nivel 2")) +
  geom_label(aes(x=57, y = 1, label = "Nivel 3")) +
  geom_label(aes(x=74, y = 1, label = "Nivel 4")) +
  geom_label(aes(x=94, y = 1, label = "Nivel 5")) +
  geom_label(aes(x=121, y = 1, label = "Nivel 6")) +
  guides(fill="none")
p2
```

Antes de proceder a concluír sobre estas dos curvas, es necesario demostrar estadísticamente si existe una diferencia significativa entre las mismas.

Veamos entonces si existe una diferencia estadísticamente significativa entre las dos curvas de supervivencia ilustradas anteriormente.

Denote $S_1(t)$: Curva de supervivencia para pacientes que no experimentan un GAP grande de tiempo y $S_2(t)$: Curva de supervivencia para pacientes que en algún momento de su tratamiento tuvieron que esperar más de quince días entre niveles.

Así entonces, mediante la prueba Log-Rank se desea juzgar el siguiente juego de hipótesis

$$
\begin{cases}
H_0: S_1(t) = S_2(t)\\
H_1: S_1(t) \neq S_2(t)
\end{cases}
$$ Con esto, usando un nivel de significancia $\alpha = 0.05$, se obtiene el siguiente resultado

```{r}
km_fit_2_test <- survdiff(Surv(dias, evento) ~ GAP, data = Datosdepurados)

test_res <- data.frame(chi = km_fit_2_test$chisq, p = km_fit_2_test$pvalue)

kable(test_res, caption = "Resultados Prueba Log-Rank", align = "c",
      booktab = T, escape = F, col.names = c("$\\chi^2$", "Valor P"), digits = 4)
```

Teniendo en cuenta que Valor P $<<<$ $\alpha = 0.05$, se puede rechazar $H_0: S_1(t) = S_2(t)$ contundentemente, concluyendo así que la supervivencia entre los dos grupos es significativamente diferente.

Así entonces se pueden realizar las siguientes conclusiones.

-   La supervivencia de los pacientes que en algún momento de su tratamiento experimentan un GAP de tiempo excesivo parece ser superior a la de los pacientes que no tienen que esperar mucho antes de iniciar su siguiente nivel respectivo, es decir, los pacientes que en algún momento deben esperar mucho por una cita de control parecen adherirse mas al tratamiento, resultado completamente contraintuitivo.

-   **Sin embargo, el GAP de tiempo mencionado puede no ser debido exclusivamente al tiempo en que se programa una cita de control. En ocasiones, se puede considerar adecuado que un paciente realice ciertos ejercicios durante un periodo de tiempo antes de comenzar el siguiente nivel, lo cual no es necesariamente negativo, por el contrario puede pensarse que un acompañamiento cercano al paciente lo motiva más y hace que el mismo mejore sus probabilidades de terminar exitosamente el tratamiento.**

-   Si bien los pacientes que experimentan un GAP grande de tiempo parecen adherirse más al tratamiento, hay que concluír con cuidado en este aspecto, porque el tiempo prolongado en la programación de estas citas de control pueden estar inflando falsamente la supervivencia de un paciente que más adelante no va a continuar con su tratamiento.

## ¿Realmente sobreviven más los pacientes con GAP grande?

```{r}
proportions <- table(Datosdepurados$Status, Datosdepurados$GAP) %>% 
  prop.table(margin = 2) %>% as.data.frame() %>% mutate(Status = ifelse(Var1=="Evento",
                                                                        "Abandonó",
                                                                        "Continuó"),
                                                        GAP = Var2, 
                                                        Proportion = Freq) %>%
  select(GAP, Proportion, Status)

gapplot <- ggplot(proportions, aes(x = GAP, y = Proportion, fill = Status)) + 
  geom_bar(stat = "identity", position=position_dodge()) +
  geom_text(aes(label=Proportion %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "Tiempo (GAP) entre niveles", 
       y = "Proporción", 
       title = "Proporción de pacientes que abandonaron de acuerdo al GAP",
       fill = "Condición") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10)) 
gapplot
```

Note que de acuerdo a este gráfico, para los pacientes que no experimentan un tiempo de espera mayor a quince días entre sus niveles, el 83% de los mismos abandonaron el tratamientos. Sin embargo, para aquellos pacientes que en algún momento del tratamiento tuvieron que esperar más de quince días para iniciar un nuevo nivel, esta proporción es menor, pues en este caso, solo el 59% abandonó el tratamiento.

\newpage

## Análisis descriptivo: Pacientes que llegaron a la meta

Se dispone de una base de datos que contiene información relacionada a 126 pacientes que completaron el tratamiento miofuncional orofacial (TMO) en todos sus niveles. En dicha base de datos se encuentra consignada información relacionada a comorbilidades, condiciones oclusales, diversos índices, edad, sexo etc. de cada uno de los pacientes que completaron el tratamiento. La estructura de la base de datos así como algunas variables se ilustran en la siguiente tabla:

```{r}
Datos130 <- read_excel("Datos130Adecuada.xlsx")%>% 
  filter(`ESQUEMA NIVEL 1` == "TMO NIVEL 1")

kable(head(Datos130[c(2,3,4,9,8)]), caption = "Estructura de los datos", align = "c",
      booktab = T, escape = F, digits = 4)
```

En este ejemplo, la variable "PuntGeneral" es una escala continua de 1-5 que indica el nivel de satisfacción/efectividad del tratamiento del paciente, donde 1 indica un paciente que considera inefectivo el tratamiento y 5 indica que el paciente considera el tratamiento absolutamente efectivo.

### Variables esquema, sexo, edad e IMC

Así entonces, para dar inicio al análisis descriptivo, se plantean los siguientes gráficos:

```{r}
plot1 <- ggplot(prop.table(table(Datos130$SEXO)) %>% as.data.frame(), aes(x = Var1, y = Freq)) + 
  geom_bar(stat = "identity", fill = "darkgreen") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "Sexo", 
       y = "Proporción", 
       title = "Proporción de pacientes por sexo") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10)) 
plot2 <- ggplot(Datos130, aes(x = EDAD)) +
  geom_density(color="darkblue", fill="lightblue") + 
  labs(x = "Edad", 
       y = "Densidad", 
       title = "Concentración de la edad de los pacientes") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10)) +
  scale_x_continuous(breaks = seq(15,80,5), limits = c(15,80))

plot3 <- ggplot(Datos130, aes(x = IMC)) +
  geom_density(color="darkred", fill="red") + 
  labs(x = "IMC", 
       y = "Densidad", 
       title = "Concentración del IMC") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
ggarrange(plot1,plot2,plot3)
```
Según estos gráficos se tienen las siguientes apreciaciones:

- El 61% de los pacientes son femeninos, diferencia significativa con la muestra masculina.

- En general, el rango de edad de los pacientes del tratamiento es de los 18 a 75 años, y según el gráfico, hay una concentración destacable de pacientes entre los 30 y 40 años, sin embargo la concentración más apreciable de pacientes se encuentra entre los 50 y 60 años de edad. 

- De manera similar, el índice de masa corporal centra usualmente sus valores alrededor del 25, sin embargo se puede notar una pequeña moda alrededor del 32 que podría indicar un porción considerable de pacientes en el rango de la obesidad.

### Análisis escala Epworth

Para lo que respecta a la escala de Epworth, observe el siguiente gráfico:

```{r}
plot4 <- ggplot(data.frame(X1 = c(rep("Salida", 87), rep("Basal",87)),
                  X2 = c(Datos130$`EPWORTH SALIDA`, Datos130$`EPWORTH BASAL`)), 
       aes(y = X2, fill = X1)) + geom_boxplot() +
  labs(x = "", 
       y = "Resultado", 
       title = "Resultado Epworth Basal vs. Salida",
       fill = "Momento") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

plot4
```

- De este boxplot se puede apreciar que existe una diferencia aparente en el resultado de la escala de somnolencia entre el momento de entrada y salida de un paciente al tratamiento. En general puede decirse que una vez concluído el tratamiento, los pacientes se autoperciben menos somnolientos respecto al momento de entrada a la terapia miofuncional orofacial.

\newpage

### Síntomas reportados

Ahora, en relación a los síntomas que reportan los pacientes al momento de la terapia, observe los siguientes gráficos:

```{r, fig.height=3}
plot5 <- ggplot(prop.table(table(Datos130$`SINTOMA PRINCIPAL`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Síntoma Principal",
       fill = "Síntoma") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())
plot5
```

- De este gráfico se aprecia que en este caso, el 29% de los pacientes definieron el ronquido como su síntoma principal. Otro síntoma destacable en este caso es la dificultad para mantener el sueño, puesto el 16% de las veces como síntoma principal.

\newpage

### Tipo de examen de sueño

Observe ahora el siguiente gráfico en relación al tipo de examen de sueño

```{r}
plot6 <- ggplot(prop.table(table(Datos130$`TIPO EXAMEN DE SUEÑO`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción por tipo de examen",
       fill = "Tipo") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot6
```

- La mayoría de pacientes que ingresan al tratamiento se les practica una Polisomnografía como examen del sueño, abarcando el 83% de los casos.

\newpage

### Índices y variables numéricas

Se plantean ahora los siguientes gráficos relativos a índices y variables numéricas

```{r, fig.height=8}
plot7 <- ggplot(Datos130, aes(x = `IAH BASAL`)) +
  geom_density(color="orange", fill="darkorange") + 
  labs(x = "", 
       y = "Densidad", 
       title = "IAH Basal") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
plot8 <- ggplot(Datos130, aes(x = `INDICE DE RONQUIDO/h`)) +
  geom_density(color="orange", fill="darkorange") + 
  labs(x = "", 
       y = "Densidad", 
       title = "Indice de Ronquido/h") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
plot9 <- ggplot(Datos130, aes(x = `% SpO2`)) +
  geom_density(color="orange", fill="darkorange") + 
  labs(x = "", 
       y = "Densidad", 
       title = "% SpO2") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))

plot10 <- ggplot(Datos130, aes(x = `MÍNIMAS DE O2`)) +
  geom_density(color="orange", fill="darkorange") + 
  labs(x = "", 
       y = "Densidad", 
       title = "Minimas de o2") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))

plot11 <- ggplot(Datos130, aes(x = `T 90`)) +
  geom_density(color="orange", fill="darkorange") + 
  labs(x = "", 
       y = "Densidad", 
       title = "T 90") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))

ggarrange(plot7,plot8,plot9,plot10,plot11, ncol = 2, nrow = 3)
```
De este conjunto de gráficos se aprecia lo siguiente:

- Los valores más usuales para el índice de apneas hipoapneas de sueño se centran alrededor de 10. La gran mayoría de los pacientes registran este índice entre los valores de 0 y 20; sin embargo existen pacientes que tienen registros más altos llegando al caso extremo de un paciente que registra un índice de 66.3 apneas hipoapneas de sueño.

- La curva de densidad para el índice de ronquido se nota un poco más extendida sobre su rango, donde un poco menos de la mitad de los pacientes registran menos de 100 en este índice de ronquido. Nuevamente se aprecia una cola hacia la derecha de la distribución muestral de esta variable, lo que indica presencia de valores extremos por encima de 500.

- Los porcentajes de SpO2 varían entre 0.84 y 0.96, centrando sus valores (usuales) en el 92%. La mayoría de pacientes en este aspecto registran entre 90% y 94% de saturación promedio por horas de sueño grabadas durante el examen; sin ebargo existe una ligera cola a la izquierda de esta dsitribución que indica valores por debajo del 88% que resultan atípicos según el comportamiento normal de esta variable.

- Una situación similar se aprecia cuando se observa la curva de las mínimas de o2. En este punto los valores se concentran entre 0.75 y 0.90. Sin embargo y de manera análoga al gráfico anterior, en esta distribución se aprecia una cola a la izquiera lo que indica la presencia de valores extremos y atípicamente pequeños.

- Finalmente, en lo que respecta al porcentaje de tiempo en el que la saturación de oxigeno estuvo por debajo de 90% por el total de horas de sueño grabadas, se puede apreciar que los valores se concentran a la izquierda del 25%, siendo los porcentajes más pequeños los más usuales. Sin embargo se aprecia que existen valores grandes que extienden la distribución hasta un 100%.

### Relativo a vías aereas superiores

En relación a las vías aereas superiores, se plantean los siguientes gráficos:

```{r}
plot12 <- ggplot(prop.table(table(unlist(strsplit(Datos130$`CUAL (ES)`, ", ")))) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción por procedimiento quirúrgico",
       fill = "Tipo") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot13 <- ggplot(prop.table(table(Datos130$OVAS)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con OVAS",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot12
plot13
```

- Del primer gráfico se abserva que, el 74% de los pacientes no ha tenido una cirugía en sus vías aéreas superiores. El 11% ha tenido una Amigdalectomía, el 9% una Turbinoplastia y el 5% una Septoplastia. 

- Del segundo se concluye que el 63% de los pacientes no poseen obstrucciones de la vía aérea superior.

\newpage

### Condiciones relacionadas a la cavidad oral

En los siguientes gráficos se analizan algunas condiciones relacionadas a la cavidad oral de los pacientes:

```{r}
plot14 <- ggplot(prop.table(table(Datos130$`LENG RETRAÍDA`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nLengua Retraída",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot15 <- ggplot(prop.table(table(Datos130$`UVULA ALARGADA`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nUvula Alargada",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot16 <- ggplot(prop.table(table(Datos130$`VELO DESCENDIDO`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nVelo Descendido",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot17 <- ggplot(prop.table(table(Datos130$`PILARES ERITEMATOSOS`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nPilares Eritematosos",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

ggarrange(plot14,plot15,plot16,plot17)
```

- Del primero se nota que el 68% de los pacientes que terminaron su tratamiento poseen la condición de lengua retraída.

- Similarmente, el 84% de los pacientes poseen una uvula alargada, mientras que en un 8% de las personas no se logra concluír sobre esta condición.

- Igualmente, en lo que al velo descendido respecta, se observa que el 94% de los pacientes del tratamiento tienen esta condición.

- De manera casi idéntica, el 95% de los pacientes registra pilares eritematosos.

¿Existe entonces una relación entre las últimas dos condiciones? Véase la siguiente tabla:

```{r}
kable(table(Datos130$`VELO DESCENDIDO`, Datos130$`PILARES ERITEMATOSOS`), caption = "VELO DESCENDIDO VS PILARES ERITEMATOSOS", align = "c",
      booktab = T, escape = F, digits = 4)
```

De esta tabla se aprecia que prácticamente todos los pacientes que poseen velo descendido, poseen además pilares eritematosos; sin embargo, para probar esta cuestión de manera formal, se plantea el siguiente juego de hipótesis:

$$
\begin{cases}
H_0: \text{Las condiciones velo descendido y pilares eritematosos no están relacionadas}\\
H_1: \text{Las condiciones velo descendido y pilares eritematosos están relacionadas}
\end{cases}
$$
Para juzgar este juego de hipótesis se plantea el test $\chi^2$ de Pearson para independencia de tablas de contingencia. Los resultados son como sigue:

```{r}
chisqtest <- chisq.test(table(Datos130$`VELO DESCENDIDO`, Datos130$`PILARES ERITEMATOSOS`))

chisqtest_res <- data.frame(chi = chisqtest$statistic, 
                            df = chisqtest$parameter, 
                            p = "1.5E-7")

kable(chisqtest_res, caption = "Resultados Prueba de Independencia", align = "c",
      booktab = T, escape = F, col.names = c("$\\chi^2$","DF", "Valor P"), digits = 4,
      row.names = F)
```

De acuerdo a este resultado y usando cualquier nivel de significancia ($\alpha$) usual, se rechaza la hipótesis nula ($H_0$) concluyendo de este modo que existe una relación estadísticamente significativa entre las condiciones bucales "velo descendido" y "pilares eritematosos" de los pacientes en cuestión.

### Comorbilidades

Para tener una perspectiva de las comorbilidades entre los pacientes del tratamiento, se plantean los siguientes gráficos:

```{r}
plot18 <- ggplot(prop.table(table(Datos130$CO_Cardiovasculares)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \ncomorbilidades cardiovasculares",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot19 <- ggplot(prop.table(table(Datos130$CO_Endocrino_metabólicas)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \ncomorbilidades endocrino-metabólicas",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot20 <- ggplot(prop.table(table(Datos130$CO_Psiquiátricas)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \ncomorbilidades psiquiátricas",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot21 <- ggplot(prop.table(table(Datos130$CO_Pulmonares)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \ncomorbilidades pulmonares",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

ggarrange(plot18,plot19,plot20,plot21)
```

- De este conjunto de gráficos se aprecia que, las comorbilidades más usuales entre los pacientes en el tratamiento son las comorbilidades cardiovasculares y las endocrino-metabólicas, esta última presente en casi la mitad de los pacientes. 

- La proporción de pacientes con comorbilidades psiquiátricas o pulmonares es baja, con 10% y 20% de los pacientes respectivamente.

### Mordida

De manera similar, para tener una perspectiva de las condiciones en la mordida de los pacientes se plantea el siguiente conjunto de gráficos:

```{r, fig.height=8}
plot22 <- ggplot(prop.table(table(Datos130$Línea_media_desviada)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nlínea media desviada",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot23 <- ggplot(prop.table(table(Datos130$Mordida_borde_a_borde)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nmordida borde a borde",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot24 <- ggplot(prop.table(table(Datos130$Mordida_abierta_anterior)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nmordida abierta anterior",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot25 <- ggplot(prop.table(table(Datos130$Mordida_cruzada)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nmordida cruzada",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot26 <- ggplot(prop.table(table(Datos130$Maloclusión_clase_II)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nmaloclusión clase II",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot27 <- ggplot(prop.table(table(Datos130$Maloclusión_clase_III)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nmaloclusión clase III",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

ggarrange(plot22,plot23,plot24,plot25,plot26,plot27, ncol=2,nrow=3)
```

- De las condiciones en la mordida de los pacientes bajo tratamiento, la línea media desviada es la más frecuente con un 63% de los pacientes que la poseen.

- Condiciones como mordida borde aborde y mordida cruzada son poco usuales entre los pacientes. En todos los casos, menos del 10% de los pacientes tuvieron alguna de estas condiciones.

- El 18% y 11% de los pacientes reportaron maloclusión clase II y maloclusión clase III respectivamente.

### Maniobras de bostezo y fonema

Ahora, para visualizar el resultado de las maniobras de bostezo y fonema para los pacientes que completaron el tratamiento, se exponen los siguientes gráficos:

```{r}
plot28 <- ggplot(prop.table(table(Datos130$`MAN BOSTEZO - VELO`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Resultados de Maniobra Bostezo - Velo",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())
plot28
```

- De este gráfico se puede apreciar que el 79% de los pacientes ascienden el velo en la maniobra de bostezo, con un 51% para aquellos que lo hacen de forma reducida, y un 28% para aquellos que en la maniobra de bostezo ascienden el velo totalmente. Un 16% de los pacientes poseen un dorso lingual lo suficientemente alto para impedir la conclusión en esta maniobra. 


```{r}
plot29 <- ggplot(prop.table(table(Datos130$`MAN BOSTEZO - ÚVULA`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Resultados de Maniobra Bostezo - Úvula",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())
plot29
```

- Continuando con la misma maniobra pero observando la úvula, en el gráfico se logra apreciar que 1/4 de los pacientes no contrae la úvula en la maniobra de bostezo, proporción análoga a aquellos pacientes que si la contraen durante la maniobra. En este caso la mayoría de los pacientes poseen un dorso lingual lo suficientemente alto para que el resultado no sea concluyente, sin embargo la diferencia con los demás grupos es reducida.


```{r}
plot30 <- ggplot(prop.table(table(Datos130$`MAN. FONEMA - VELO`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Resultados de Maniobra Fonema - Velo",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())
plot30
```

- Pasando a la maniobra de fonema, según el gráfico se puede observa que un 66% de los pacientes asciende el velo de manera reducida en esta prueba. En este caso los pacientes que no ascienden el velo son minoría con un 8% y los demás grupos empatan sus proporciones con cerca de un 14%.


```{r}
plot31 <- ggplot(prop.table(table(Datos130$`MAN FONEMA - ÚVULA`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Resultados de Maniobra Fonema - Úvula",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())
plot31
```

- Finalmente, observando la úvula en la maniobra de fonema, se puede notar que una mayoría de los pacientes no la contraen en este ejercicio con un 32% del total de los participantes. Es destacable en este caso que hay una gran proporción (32%) de pacientes con un dorso lingual tan alto como para no observar el resultado de la práctica. 

## Continuación: Variable respuesta vs. regresores

Como se comentó en el principio del análisis descriptivo, la variable "PuntGeneral" es una escala continua de 1-5 que indica el nivel de satisfacción/efectividad del tratamiento del paciente, donde 1 indica un paciente que considera inefectivo el tratamiento y 5 indica que el paciente considera el tratamiento absolutamente efectivo.

Esta variable configura en sí misma un indicador de desempeño del tratamiento, y es de interés central poder determinar cuáles son los factores que afectan la percepción del paciente en relación a la efectividad del tratamiento. Por esta razón, en haras de una etapa de modelamiento predictivo posterior, se realiza un análisis descriptivo en relación a la puntuación general que asignan los pacientes de acuerdo al éxito del tratamiento.

\newpage

### Distribución de la variable respuesta

Antes de comenzar con el análisis descriptivo de la respuesta vs las covariables en cuestión, es necesario graficar la curva de densidad de la variable respuesta para determinar así una plausible distribución teórica y para tener una visión general de lo obtenido por los pacientes:

```{r}
plotA <- ggplot(Datos130, aes(x = PuntGeneral)) +
  geom_density(color="aquamarine", fill="aquamarine3") + 
  labs(x = "Nivel de Satisfacción", 
       y = "Densidad", 
       title = "Densidad de la puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
plotA
```

- De este gráfico se puede ver inicialmente que la distribución posee una cola apreciable a la izquierda del 4, adicionalmente se puede ver que la curva es notablemente no-simétrica, por lo cual modelar la respuesta vía un modelo de regresión lineal puede no ser adecuado.

- La mayoría de los puntajes se sitúan en torno al 4, es decir que los pacientes en una gran medida consideran el tratamiento satisfactorio/efectivo. También puede verse que existe una concentración en menor medida cerca al 5, por lo que puede decirse que también hay una porción significativa de los pacientes que consideran el tratamiento absolutamente satisfactorio/efectivo.

\newpage

### Respuesta vs. Edad, Sexo, IMC y Empworth basal

Véase ahora la relación de la puntuación obtenida con las variables mencionadas.

```{r, fig.height=7}
plotB <- ggplot(Datos130, aes(x = EDAD, y = PuntGeneral)) +
  geom_point(color = "aquamarine3") +
  geom_smooth(method='lm', se = F, color = "red") +
  labs(x = "EDAD", 
       y = "Puntuación", 
       title = "Relación entre edad y puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
plotC <- ggplot(Datos130, aes(fill = SEXO, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Boxplot Sexo Vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
plotD <- ggplot(Datos130, aes(x = IMC, y = PuntGeneral)) +
  geom_point(color = "chartreuse3") +
  geom_smooth(method='lm', se = F, color = "red") +
  labs(x = "IMC", 
       y = "Puntuación", 
       title = "Relación entre IMC y puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
plotE <- ggplot(Datos130, aes(x = `EPWORTH BASAL`, y = PuntGeneral)) +
  geom_point(color = "chocolate3") +
  geom_smooth(method='lm', se = F, color = "red") +
  labs(x = "EPWORTH BASAL", 
       y = "Puntuación", 
       title = "Relación entre Epworth basal y puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
ggpubr::ggarrange(plotB,plotC,plotD,plotE)
```

- Del primer gráfico en relación a la edad, se puede notar que aparentemente, los pacientes mayores suelen calificar mejor al tratamiento; sin embargo esta relación es muy débil (la línea roja es casi horizontal) por lo que esta variable puede no ser significativa para el modelo.

- Del gráfico relativo al sexo se puede notar que las dos cajas se traslapan totalmente, lo que indica en este caso que no existe una diferencia significativa entre masculinos y femeninas a la hora de calificar el tratamiento. Nótese que hay dos puntuaciones atípicamente bajas para las mujeres y una para los hombres.

- De manera similar al primer gráfico, en el tercero se puede apreciar que no existe una relación entre el IMC y la puntuación que los pacientes reportan.

- Finalmente, en lo que respecta al resultado del cuestionario epworth se puede notar que sí existe una relación medianamenete plausible entre dicha variable y la puntuación de efectividad. Particularmente se nota que los pacientes menos somnolientos suelen calificar mejor al tratamiento.

### Síntoma principal

De esta variable surge el cuestionamiento natural: ¿Existe una relación entre el síntoma principal reportado y la puntuacón obtenida?

```{r}
plotF <- ggplot(Datos130, aes(fill = `SINTOMA PRINCIPAL`, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Boxplot Síntoma Principal Vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
plotF
```

- Se puede apreciar que existe una diferencia signficativa entre los paciente que se despiertan con ahogo y los pacientes somnolientos, donde estos últimos suelen calificar mejor los resultados del tratamiento. Este mismo comportamiento es notable con los pacientes que sufren cefalea matutina y cansancio crónico.

### Índices y porcentajes

Ahora se analiza la relación entre algunas variables numéricas y la respuesta en cuestión

```{r, fig.height=9}
plotG <- ggplot(Datos130, aes(x = `IAH BASAL`, y = PuntGeneral)) +
  geom_point(color = "darkorchid") +
  geom_smooth(method='lm', se = F, color = "red") +
  labs(x = "IAH BASAL", 
       y = "Puntuación", 
       title = "IAH basal vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
plotH <- ggplot(Datos130, aes(x = `INDICE DE RONQUIDO/h`, y = PuntGeneral)) +
  geom_point(color = "darkorchid") +
  geom_smooth(method='lm', se = F, color = "red") +
  labs(x = "INDICE DE RONQUIDO/h", 
       y = "Puntuación", 
       title = "INDICE DE RONQUIDO/h vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
plotI <- ggplot(Datos130, aes(x = `% SpO2`, y = PuntGeneral)) +
  geom_point(color = "darkorchid") +
  geom_smooth(method='lm', se = F, color = "red") +
  labs(x = "% SpO2", 
       y = "Puntuación", 
       title = "% SpO2 vs puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
plotJ <- ggplot(Datos130, aes(x = `MÍNIMAS DE O2`, y = PuntGeneral)) +
  geom_point(color = "darkorchid") +
  geom_smooth(method='lm', se = F, color = "red") +
  labs(x = "MÍNIMAS DE O2", 
       y = "Puntuación", 
       title = "MÍNIMAS DE O2 vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
plotK <- ggplot(Datos130, aes(x = `T 90`, y = PuntGeneral)) +
  geom_point(color = "darkorchid") +
  geom_smooth(method='lm', se = F, color = "red") +
  labs(x = "T 90", 
       y = "Puntuación", 
       title = "T 90 vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
ggpubr::ggarrange(plotG,plotH,plotI,plotJ,plotK, ncol = 2, nrow = 3)
```

- De este grupo de gráficos se puede notar que la variable que tiene una relación apreciable con la respuesta en este caso es T 90, los demás índices y porcentajes no muestran una relación plausible que permita concluir de antemano significancia para explicar el puntaje obtenido.

### Antecedentes quirurgicos en vías aereas superiores

```{r}
plotL <- ggplot(Datos130, aes(fill = `ANTC QX EN VAS`, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Boxplot ANTC QX EN VAS Vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
plotL
```

- Se aprecia que no existe relación aparente entre la percepción de efectividad del tratamiento y los antecedentes quirurgicos en vías aereas superiores.

\newpage

### OVAS

¿Afecta el poseer obstrucciones en la vía aerea superior en la percepción de efectividad del tratamiento?

```{r}
plotM <- ggplot(Datos130, aes(fill = OVAS, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Boxplot Ovas Vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
plotM
```

- Similar a lo obtenido en el apartado anterior, el hecho de poseer algún tipo de obstrucción en las vías aereas superiores aparentemente no afecta el puntaje que se obtiene de efectividad/satisfacción del tratamiento.

\newpage

### Condiciones de la cavidad oral vs puntuación

Ahora se analizarán las condiciones de la cavidad oral en relación a la variable respuesta en cuestión:

```{r}
plotN <- ggplot(Datos130, aes(fill = `LENG RETRAÍDA`, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Lengua Retraída Vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
plotO <- ggplot(Datos130[-9,], aes(fill = `UVULA ALARGADA`, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Úvula Alargada Vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
plotP <- ggplot(Datos130, aes(fill = `VELO DESCENDIDO`, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Velo Descendido Vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
plotQ <- ggplot(Datos130, aes(fill = `PILARES ERITEMATOSOS`, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Pilares Eritematosos Vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
ggpubr::ggarrange(plotN,plotO,plotP,plotQ)
```

- De este conjunto de gráficos se logra apreciar que las condiciones de lengua retraída y úvula alargada no influyen en el resultado de puntaje; sin embargo, condiciones como velo descendido y pilares eritematosos sí parecen ser significativos para explicar la variable respuesta.

- Es importante tener en cuenta lo obtenido en el análisis descriptivo marginal respectivo a estas variables, pues allí se encontró una relación directa en las últimas dos variables, lo cuál podría indicar adecuado incluír un término de interaccion en el futuro modelo predictivo.

### Maniobras de bostezo y fonema vs puntuación

Ahora, para visualizar el resultado de las maniobras de bostezo y fonema para los pacientes que completaron el tratamiento en relación al resultado que reportan, se exponen los siguientes gráficos:

```{r, fig.height=9}
plotR <- ggplot(Datos130, aes(fill = `MAN BOSTEZO - VELO`, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Bostezo (Velo) Vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

plotS <- ggplot(Datos130, aes(fill = `MAN BOSTEZO - ÚVULA`, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Bostezo (Úvula) Vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

plotT <- ggplot(Datos130, aes(fill = `MAN. FONEMA - VELO`, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Fonema (Velo) Vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

plotU <- ggplot(Datos130, aes(fill = `MAN FONEMA - ÚVULA`, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Fonema (Úvula) Vs Puntuación") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
ggpubr::ggarrange(plotR,plotS,plotT,plotU,ncol=1,nrow=4)
```

- De este último grupo se nota que en cada gráfico todas las cajas se traslapan unas a otras, por lo cual se puede concluír que estas variables no ayudan a explicar el puntaje obtenido con cada paciente y que en la propuesta de un modelo es probable que no muestren significancia suficiente para ser incluídas en el mismo.

### Variables relativas a comorbilidades

```{r}
plotV <- ggplot(Datos130, aes(fill = CO_Cardiovasculares, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Comorb Cardiovasculares\n Vs Puntuación",
       fill = "Cardiovasculares") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
plotW <- ggplot(Datos130, aes(fill = CO_Endocrino_metabólicas, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Comorbilidades Endocrino-Metabólicas\n Vs Puntuación",
       fill = "Endoc-Metab") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
plotX <- ggplot(Datos130, aes(fill = CO_Psiquiátricas, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Comorbilidades Psiquiátricas\n Vs Puntuación",
       fill = "Psiquiátricas") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
plotY <- ggplot(Datos130, aes(fill = CO_Pulmonares, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Comorbilidades Pulmonares\n Vs Puntuación",
       fill = "Pulmonares") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

ggpubr::ggarrange(plotV,plotW,plotX,plotY)
```

- En lo que respecta a las comorbilidades, se puede apreciar que existe una relación evidente entre la puntuación que dan los pacientes y si los mismos poseen algún tipo de comorbilidad psiquiátrica, donde aquellos que sí poseen alguna, perciben el tratamiento significativamente más efectivo. Esta relación también es plausible para aquellos pacientes con comorbilidades cardiovasculares, sin embargo en este punto la relación es más débil.

### Mordida vs Respuesta

Finalmente, en lo que respecta a la mordida relacionado a la efectividad del tratamiento, se tienen los siguientes gráficos:

```{r, fig.height=9}
plotZ <- ggplot(Datos130, aes(fill = Línea_media_desviada, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Línea Media Desviada\n Vs Puntuación",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

plotAA <- ggplot(Datos130, aes(fill = Mordida_borde_a_borde, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Mordida Borde a Borde\n Vs Puntuación",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

plotAB <- ggplot(Datos130, aes(fill = Mordida_abierta_anterior, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Mordida Abierta Anterior\n Vs Puntuación",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

plotAC <- ggplot(Datos130, aes(fill = Mordida_cruzada, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Mordida Cruzada\n Vs Puntuación",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

plotAD <- ggplot(Datos130, aes(fill = Maloclusión_clase_II, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Maloclusión Clase II\n Vs Puntuación",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

plotAE <- ggplot(Datos130, aes(fill = Maloclusión_clase_III, y = PuntGeneral)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Puntuación", 
       title = "Maloclusión Clase III\n Vs Puntuación",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

ggpubr::ggarrange(plotZ,plotAA,plotAB,plotAC,plotAD,plotAE,ncol=2,nrow=3)
```

- Con estos últimos se puede apreciar que prácticamente en todas las condiciones de la mordida, las cajas se traslapan lo suficiente para descartar una relación significativa con la variable respueta; sin embargo, en condiciones como mordida borde a borde y maloclusión clase III se puede pensar en una relación débil plausible. En ese sentido sería interesante incluír este grupo de covariables al modelo como una interacción. 

## Modelación de la variable de puntuación general

Dado que la distribución de la variable respuesta es altamente no simétrica y con una forma desconocida, además de que algunas relaciones con las covariables son débiles, se considera adecuado optar por modelos predictivos robustos propios del machine learning (un enfoque analítico predictivo) que no posean supuestos distribucionales y donde prime el poder predictivo y la minimización del error en las predicciones.

En ese sentido, se tendrán las siguientes consideraciones:

- Para evaluar el desempeño del modelo se utilizará el RMSE (Raíz del error cuadrático medio).

$$ 
RMSE = \sqrt{\sum_{i=1}^n\frac{(y_i-\hat{y_i})^2}{n}}
$$
Con $n = 87$ el número de observaciones en la base de datos, $y_i$ el valor real de la respuesta y $\hat{y_i}$ el valor predicho por el modelo.

- Con esta métrica se escogerá el modelo más preciso.

- Para prevenir el overfitting (sobreajuste) se optará por usar el método cross validation partiendo el conjunto de datos en proporción 80% para entrenamiento y 20% para prueba. Si el RMSE de ambos conjuntos difiere en más de un 15% se considerará que el modelo sobreajusta los datos y será descartado.

- Para el ajuste de los modelos se seleccionarán las variables que poseen una relación destacable con la respuesta: Edad, epworth basal, síntoma principal, T90, comorbilidades cardiovasculares y psiquiátricas, pilares eritematosos, mordida borde a borde y maloclusión clase III.

```{r}
modelformulas <- c("PuntGeneral ~ `EPWORTH BASAL` + `SINTOMA PRINCIPAL`", "PuntGeneral ~ `EPWORTH BASAL` + `SINTOMA PRINCIPAL` + CO_Psiquiatricas", "PuntGeneral ~ `EPWORTH BASAL` + `SINTOMA PRINCIPAL` + CO_Psiquiatricas + `T 90`", "PuntGeneral ~ `EPWORTH BASAL` + `SINTOMA PRINCIPAL` + CO_Psiquiatricas + `T 90` + EDAD", "PuntGeneral ~ `EPWORTH BASAL` + `SINTOMA PRINCIPAL` + CO_Psiquiatricas + `T 90` + EDAD + Maloclusion_clase_III", "PuntGeneral ~ `EPWORTH BASAL` + `SINTOMA PRINCIPAL` + CO_Psiquiatricas + `T 90` + EDAD + Maloclusion_clase_III + CO_Cardiovasculares", "PuntGeneral ~ `EPWORTH BASAL` + `SINTOMA PRINCIPAL` + CO_Psiquiatricas + `T 90` + EDAD + Maloclusion_clase_III + CO_Cardiovasculares + `PILARES ERITEMATOSOS`", "PuntGeneral ~ `EPWORTH BASAL` + `SINTOMA PRINCIPAL` + CO_Psiquiatricas + `T 90` + EDAD + Maloclusion_clase_III + CO_Cardiovasculares + `PILARES ERITEMATOSOS` + Mordida_borde_a_borde")

names(Datos130)[c(32,39)] <- c("CO_Psiquiatricas", "Maloclusion_clase_III")
set.seed(1007221901)
indexes <- sample(1:87, 70)
train <- Datos130[indexes,]
test <- Datos130[-indexes,]

rmse <- function(model, nombremodelo){
  predictionstrain <- predict(model, train)
  predictionstest <- predict(model, test)
  rmsetrain <- sqrt(mean((train$PuntGeneral-predictionstrain)^2))
  rmsetest <- sqrt(mean((test$PuntGeneral-predictionstest)^2))
  overtest <- abs(rmsetrain-rmsetest)/rmsetrain
  
  return(data.frame(Modelo = nombremodelo, RMSE_TRAIN = rmsetrain, RMSE_TEST = rmsetest,                              ErrorRelativo = round(overtest,2)))
}
```

### Modelos a considerar

Para cada tipo de modelo se van a considerar 8 conjuntos de regresores, donde cada fórmula se encuentra anidada en un modelo más específico (ver la siguiente tabla). Para la elección de las fórmulas se tuvieron en cuenta primero las variables que en el análisis descriptivo resultaron más significativas, sucesivamente se fueron agregando variables con las relaciones más plausibles en orden de significancia. 

\newpage
```{r}
kable(data.frame(Modelo = 1:8, Fórmula = modelformulas), 
      caption = "Fórmulas consideradas", align = c("l","r"),
      booktab = T, escape = F)
```

Para cada propuesta de modelo, se ajustarán las ocho fórmulas y se elegirá al mejor modelo objetivamente, se considerará a ese como el mejor de su clase y se pondrá a competir con las demás propuestas.

### Modelo de regresión lineal múltiple

Se opta por esta clase de modelo como una base o referencia para propuestas futuras. En este caso se aborda este modelo desde una perpectiva analítica predictiva mas no inferencial, por lo cual se obvian los supuestos del modelo y no se realiza análisis de significancia y e inferencia sobre los demás coeficientes.

Los resultados son los siguientes

```{r}
lmresults <- data.frame()

for (i in 1:8){
  model <- lm(as.formula(modelformulas[i]), data = train)
  result <- rmse(model, paste("Fórmula", i))
  lmresults <- rbind(lmresults, result)
}


kable(lmresults, 
      caption = "Resultados Modelo Lineal Múltiple", align = "c",
      booktab = T, escape = F)
```

De este resultado es notable que ninguno de los ocho modelos propuestos con regresión lineal múltiple sobreajusta los datos, es decir, el modelo tiene un buen poder predictivo con datos que no conoce y posee la capacidad de generalizar las predicciones. El mejor modelo encontrado es el que contiene todas las variables significativas, con un error medio de 0.68 en el conjunto de datos de entrenamiento, y un error medio de 0.63 en el conjunto de datos de prueba.

### K-Nearest Neighbors Regression

El algoritmo de K vecinos más cercanos para regresión es la extensión del algoritmo de KNN pero en este caso para problemas predictivos con respuesta continua. El algoritmo puede explicarse de manera intuitiva:

- Considere una nube de puntos con los valores de un conjunto de regresores.
- Considere una nueva observación.
- Ubique esa observación en su punto respectivo de la nube de puntos.
- Tome los valores de los k vecinos más cercanos a esa nueva observación.
- Promedie dichos valores y esa será la predicción de la respuesta para la nueva observación.

En este caso particular, el hiperparámetro k se seleccionará mediante el procedimiento LOOCV (leave one out cross validation) sobre el conjunto de entrenamiento. Este procedimiento se hará por cada fórmula.

El resultado se expone como sigue:

```{r}
trctrl <- trainControl(method="LOOCV")
grid <- expand.grid(k = seq(3,15,3))
knnresults <- data.frame()
kvals <- c()
for (i in 1:8){
  model <- train(as.formula(modelformulas[i]), data = train, method = "knn",
                 trControl = trctrl, tuneGrid = grid)
  result <- rmse(model, paste("Fórmula", i))
  knnresults <- rbind(knnresults, result)
  kvals[i] <- as.numeric(model$bestTune)
}

kable(cbind(knnresults, data.frame(BestK = kvals)), 
      caption = "Resultados Modelo KNN-REG", align = "c",
      booktab = T, escape = F)
```

En este caso la columna "BestK" hace referencia al hiperparámetro K que mejor desempeño predictivo muestra para cada fórmula.

De este último resultado se alcanza a apreciar que en ningún caso el modelo knn-reg sobreajusta los datos y se muestra con un poder predictivo destacable. Sin embargo, este modelo predictivo no logra mejorar los resultados obtenidos por el modelo lineal tradicional en train y test.

### Bagging: Random Forest

Ramdom Forest o bosque aleatorio es un algoritmo que extiende el uso de los árboles de decisión. 

El principio de esta clase de modelo consiste en ajustar una cantidad n determinada de árboles de decisión, luego se realiza la predicción con cada árbol y se escoge la predicción por mayoría. El funcionamiento simplificado se ilustra así

```{r,out.width="50%", fig.cap="Idea de Random Forest", fig.align='center'}
knitr::include_graphics("rf.png")
```

```{r}
rfresults <- data.frame()
for (i in 1:8){
  model <- train(as.formula(modelformulas[i]), data = train, method = "rf")
  result <- rmse(model, paste("Fórmula", i))
  rfresults <- rbind(rfresults, result)
}

kable(rfresults, 
      caption = "Resultados Modelo Random Forest", align = "c",
      booktab = T, escape = F)
```
Antes de concluir se debe conocer que el número de árboles empleado es, por defecto, 500.

A partir de este resultado se puede observar que el error relativo del modelo random forest con el primer conjunto de variables independientes es del 15% aproximadamente, por lo cual puede pensarse en overfitting; sin embargo, esto no es así porque el modelo está prediciendo mejor en el conjunto de prueba que en el de entrenamiento, por lo cuál no incurre en overfitting. Sin embargo, se debe resaltar que el modelo respectivo a la fórmula 6 reporta un excelente desempeño tanto en train como en test, sin incurrir en overfitting, por lo cuál este es un gran candidato a modelo final.

### Boosting: Stochastic Gradient Boosting

El boosting como el bagging es un modelo de ensamble, es decir, se compone por varios modelos más básicos que crean un modelo "fuerte" con altas capacidades predictivas. En el método anterior (Random Forest) se vió que este es, de manera resumida, el ensamble en paralelo de varios árboles de decisión básicos con los cuales se puede obtener mediante votación por mayoría, una predicción bastante certera. En este caso también se ensamblan varios árboles de decisión o "modelos débiles" pero en forma secuencial, de manera tal que el siguiente arbol ajuste lo que el anterior no pudo. 

Dicho esto, los resultados que se obtienen con el modelo Stochastic Gradient Boosting son

```{r}
nnetresults <- data.frame()
for (i in 1:8){
  capture.output(model <- train(as.formula(modelformulas[i]), data = train, method = "gbm"))
  result <- rmse(model, paste("Fórmula", i))
  nnetresults <- rbind(nnetresults, result)
}

kable(nnetresults, 
      caption = "Resultados Modelo Stochastic Gradient Boosting", align = "c",
      booktab = T, escape = F)
```

Dada la complejidad de este algoritmo, se dió vía libre para que el algoritmo computacional desarrollado en la librería caret hiciera el ajuste correspondiente de los hiperparámetros y así evitar errores e inestabilidades numéricas. 

Si bien el modelo boosting por descenso del gradiente estocástico no sobreajusta los datos en ningún conjunto de variables independientes, los resultados obtenidos son cuantitativamente inferiores a los obtenidos por el modelo de Random Forest, por lo cuál podría considerarse a priori que este tipo de modelo o bien no es adecuado para nuestro conjunto de datos o tal vez requiere de un desarrollo más extenso.

### Comparación de los modelos obtenidos

Una vez planteadas las cuatro propuestas de modelos (Regresión lineal múltiple, KNN-REG, Random Forest y Stochastic Gradient Boosting), se selecciona la fórmula que menor rmse reporte en cada conjunto de datos (entrenamiento y prueba) para cada uno de los mismos. En ese caso, se obtienen los "finalistas"

```{r}
bestmodels <- data.frame(Modelo = c("Modelo Lineal", "Knn-Reg", 
                                    "Random Forest", "Stoch Grad Boost"),
                         Formula = c(lmresults[8,1],knnresults[1,1],
                                     rfresults[6,1],nnetresults[1,1]),
                         RMSE_TRAIN = c(lmresults[8,2],knnresults[1,2],
                                        rfresults[6,2],nnetresults[1,2]),
                         RMSE_TEST = c(lmresults[8,3],knnresults[1,3],
                                       rfresults[6,3],nnetresults[1,3]),
                         ErrorRelativo = c(lmresults[8,4],knnresults[1,4],
                                           rfresults[6,4],nnetresults[1,4]))

kable(bestmodels, 
      caption = "Mejores modelos de cada tipo", align = "c",
      booktab = T, escape = F, col.names = c("Modelo", "Fórmula", "Rmse Train", 
                                             "Rmse Test", "Error Relativo"))
```

De esta tabla se puede apreciar que tanto en train como en test, el modelo que más se destaca en términos de rmse es el modelo Random Forest ¿Pero cómo se interpreta el rmse?: En promedio el modelo random forest se equivoca en 0.62 puntos de efectividad/satisfacción del tratamiento, se espera que para un nuevo paciente que ingresa al tratamiento, el modelo acierte su satisfacción futura con 0.62 unidades de error.

Veamos el resultado anterior de manera gráfica

```{r}
bestmodelsgraph <- data.frame(RMSE = c(lmresults[8,2],lmresults[8,3],
                                       knnresults[1,2],knnresults[1,3],
                                       rfresults[6,2],rfresults[6,3],
                                       nnetresults[1,2],nnetresults[1,3]),
                              MODELO = c("LM","LM","KNN","KNN","RF","RF","SGB","SGB"),
                              TIPO = rep(c("TRAIN","TEST"),4))

ggplot(bestmodelsgraph, aes(x = MODELO, y = RMSE, group = TIPO)) +
  geom_line(aes(color=TIPO)) + geom_point(aes(color = TIPO), size = 3) + 
  labs(x = "MODELO", 
       y = "RMSE", 
       title = "RMSE TRAIN Y TEST",
       color = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
```

Como es notable en el gráfico, tanto en el conjunto de datos de entrenamiento como en el conjunto de datos de prueba, el modelo "RF" (Random Forest) con la fórmula 6 (ver tabla 7) es el que mejores resultados demuestra en términos de error, por lo cuál este es el modelo final para explicar la respuesta "PuntGeneral".

### Anotaciones sobre el resultado

Como se comentó en la sección anterior, el mejor modelo obtenido mediante la metodología propuesta es un modelo propio del paradigma bagging, conocido como modelo Random Forest o modelo de bosques aleatorios. En este caso el modelo se entrenó con 500 árboles aleatorios usando el principio exlicado en la respectiva sección. Este modelo ajustó mejor los datos usando la fórmula 6 que se muestra a continuación: 


$$
PuntGeneral \sim EPWORTH BASAL\ +\ SINTOMA PRINCIPAL\ +\ COPsiquiatricas\ +\ T 90
$$
$$
+\ EDAD\ +\ MaloclusionClaseIII\ +\ COCardiovasculares
$$
Es decir, las covariables que resultaron al menos mínimamente significativas en el análisis descriptivo que mejor explican la puntuación que dan los pacientes al tratamiento son las 7 comprendidas en la anterior fórmula y en ese sentido, serán las que mejor determinen la percepción de efectividad del mismo.

### Visualizando el ajuste

Para visualizar el buen ajuste del modelo obtenido se plantea el siguiente gráfico

```{r}
finalmod <- train(as.formula(modelformulas[6]), data = train, method = "rf")
```

```{r}
allpredictions <- predict(finalmod,Datos130)
finalmoddata <- data.frame(Observacion = 1:nrow(Datos130),
                           Valor = c(Datos130$PuntGeneral, allpredictions),
                           Tipo = c(rep("Real",nrow(Datos130)), rep("Predicho",nrow(Datos130))))

ggplot(finalmoddata, aes(x = Observacion, y = Valor, color = Tipo)) +
  geom_line(aes(color=Tipo)) + geom_point(aes(color = Tipo), size = 2)+ 
  labs(x = "Observación", 
       y = "Puntuación", 
       title = "Valores Reales vs Ajustados",
       color = "Tipo") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
```

En este gráfico se puede observar que aunque el modelo parece conservador, realmente las desviaciones corresponden a lo reportado según el RMSE, el cuál es relativamente bajo según la desviación natural de los datos.

Es muy destacable de este modelo que logra capturar fielmente la tendencia de los pacientes, es decir, sube cuando debe subir y baja cuando debe bajar, lo que indica que el modelo está replicando el comportamiento natural de los datos y posee la capacidad de perfilar los pacientes de acuerdo a las variables involucradas en el mismo. 

### Resultado final: Perfilamiento de los pacientes

Como es de interés primario, ahora el análisis se hará de acuerdo a lo que el modelo dicte como el perfil más exitoso en el tratamiento y lo que prediga como el perfil de paciente que percibe peores resultados. Para esa causa se hará una predicción para todas las combinaciones posibles de las variables escogidas en la fórmula 6 (ver tabla 7) que se encuentren en la base de datos. Posteriormente se reportarán los mejores y peores puntajes de acuerdo al modelo obtenido y se harán las conclusiones respectivas. El resultados se muestra en la siguiete tabla.

```{r}
perfdata <- Datos130[,c(6,10,32,16,3,39,30)] %>%
  mutate("Puntaje" = allpredictions) %>%
  arrange(desc(Puntaje))
perfdatnames <- c("EPWORTH BASAL", "SÍNTOMA PRINCIPAL", "PSIQ", "T90","EDAD",                "MALOCLIII", "CARDIO", "PUNTAJE")
kable(perfdata[c(1:5,83:87),], 
      caption = "Perfiles de los pacientes", align = "c",
      booktabs = T, escape = F, digits = 2, col.names = perfdatnames)
```

- En esta tabla se ilustran los perfiles de los cinco pacientes que más éxito reportan según el modelo y los cinco perfiles de pacientes que menos satisfacción/efectividad pueden tener en el tratamiento. 

- En primera instancia se puede observar que los pacientes más exitosos suelen tener un puntaje de somnolencia bajo en comparación a los menos exitosos.

- En segundo lugar, se puede notar que un paciente con dificultad para mantener el sueño suele percibir el tratamiento más efectivo. En contraparte se aprecia que los roncadores son un perfil típico de un paciente que no suele considerarse satisfecho con el tratamiento.

- Como se vió en el análisis descriptivo, los pacientes psiquiátricos suelen percibir el tratamiento más exitoso que los que no poseen comorbilidades psiquiátricas. Esto es apreciable porque de los cinco perfiles con el puntaje más alto, 3 de ellos involucran el hecho de tener una comorbilidad psiquiátrica.

- En lo que respecta a la variable T90, se puede notar que un paciente con valores muy bajos puede considerar mejor el tratamiento, mientras que aquellos que poseen valores medios/altos en este aspecto calificarán peor al mismo.

- Nótese que los pacientes más mayores suelen considerar al tratamiento como más satisfactorio/efectivo, lo cuál implica directamente que los pacientes relativamente jóvenes suelen considerar menos exitoso el tratamiento.

- En la variable maloclusión clase III se aprecia que tanto los perfiles más exitosos como los menos exitosos no poseen esta condición, sin embargo el análisis descriptivo dicta que aquellos que poseen esta condición suelen calificar menos satisfactorio el tratamiento. Si el modelo indica que esta variable mejora las predicciones, entonces esta consideración es totalmente válida aún no siendo apreciable en la tabla.

- De manera similar ocurre con la variable que indica alguna clase de comorbilidad cardiovascular, si bien no es tan apreciable en la tabla, sí se alcanza a notar que aquellos pacientes que sí tienen comorbilidades cardiovasculares suelen calificar mejor al tratamiento.

- Finalmente, se concluye que se deben "gatillar" o "motivar" a los pacientes con los perfiles mencionados: Epworth basal alto, síntomas relacionados al ronquido, sin comorbilidades psiquiátricas, con valores T90 relativamente altos, jóvenes, que posean maloclusión clase III y que no posean comorbilidades cardiovasculares. Mientras que de aquellos con un epworth basal bajo, con síntomas relacionados a la dificultad para mantener el sueño, con comorbilidades psiquiátricas, con valores T90 bajos, en edades mayores, sin maloclusión clase III y con comorbilidades cardiovasculares se puede esperar de antemano un resultado efectivo/satisfactorio del tratamiento miofuncional orofacial. 