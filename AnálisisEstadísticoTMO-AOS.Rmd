---
title: "Análisis-TMO&AOS"
author: "Sebastian Gaviria Sánchez"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F)
library(readxl)
library(dplyr)
library(lubridate)
library(knitr)
library(ggfortify)
library(plotly)
library(survival)
library(ggpubr)
```

```{r}
#cargando la base de datos
datos <- read_excel("BD 6 MARZO 2023.xlsx")

#completando fecha de inicio
for (i in 1:nrow(datos)){
  if(is.na(datos$inicio[i])){
    datos$inicio[i] <- datos$inicio[i-1]
  }
}

#arreglando fecha fin
datos$fin <- substr(datos$fin,1,10)
datos$fin <- as.POSIXlt.character(datos$fin, tz = "UTC", format = "%d/%m/%Y")

#Quitando los cancelados
datos <- datos %>% filter(estado == "Completado")

#Calculando días
datos$dias <- difftime(datos$fin,
                       datos$inicio, 
                       units = "days") %>%
  as.numeric()
```

## Estadísticos de resumen

Se tiene gran interés en responder los siguientes cuestionamientos:

-   ¿Cuánto se demora en promedio un paciente para completar cada nivel?
-   ¿Cuánto se demora en promedio un paciente para terminar el tratamiento?

Para dar respuesta a la primera pregunta se muestra la siguiente tabla

```{r}
df_dias_promedio <- datos %>%
                    group_by(nivel) %>%
                    summarise_at(vars(dias), list(días_promedio = mean))

kable(df_dias_promedio, caption = "Días promedio por nivel del tratamiento", align = "c",
      booktab = T, escape = F, col.names = c("Nivel", "Días promedio"), digits = 1)
```

Con esta última se tienen las siguientes conclusiones:

-   En promedio, los pacientes bajo el tratamiento tardan aproximadamente 21 días en completar el nivel 1 del mismo.

-   Así mismo, para el nivel 2 de dicho tratamiento, los pacientes tardan aproximadamente 15 días para completarlo en promedio.

-   Similar al nivel 1, en el nivel 3 los pacientes bajo el tratamiento tardan en promedio 20 días en completar el mismo.

-   Para el nivel 4, se puede decir que los pacientes en promedio se tardan 17 días en llegar al final de este nivel.

-   De manera análoga al nivel 3, en el nivel 5 los pacientes también tardan en promedio 20 días aproximadamente.

-   Finalmente y a diferencia de los demás niveles, en el nivel 6 los pacientes suelen tardar más en promedio, con casi 28 días para terminar este nivel.

Ahora, interesa conocer cuánto se demora un paciente en promedio para finalizar el tratamiento en su totalidad. Para esta causa se muestra el siguiente resumen. \newpage

```{r}
Datosdepurados <- read_excel("Datosdepurados.xlsx")
Datosdepurados$dias <- difftime(Datosdepurados$`Fecha Fin`,
                                Datosdepurados$`Fecha Incio`, 
                                units = "days") %>%
  as.numeric() %>% round(2)
resultsumm <- Datosdepurados %>% filter(!is.na(`TMO NIVEL 6`)) %>% 
  select(dias) %>% summary()

df_summary_tratcomp <- data.frame(Est = c('Mínimo','Percentil 25','Mediana',
                                          'Promedio','Percentil 75','Máximo'),
                                  Freq = c(86.0,124.2,150.5,157.8,181.0,328.0))

kable(df_summary_tratcomp, caption = "Días para terminar el tratamiento", 
      align = "c", booktab = T, escape = F, 
      col.names = c("Estadístico", "Resultado"), digits = 1)

```

Con este resultado se llega a las siguientes conclusiones:

-   El paciente que menos se demoró en terminar el tratamiento lo hizo en 86 días.

-   Según el percentil 25, se afirma que el 25% de los pacientes terminan en menos de 125 días.

-   Similarmente, según la mediana la mitad de los pacientes termina el tratamiento antes de los 150 días.

-   En promedio, los pacientes tardan 158 días en terminar el tratamiento.

-   Según el percentil 75, el 75% de los pacientes tarda menos de 181 días en terminar el tratamiento.

-   Finalmente, el paciente que más tardó en terminar su tratamiento lo hizo en 328 días.

## Curva de supervivencia

En aras de determinar el comportamiento de deserción a lo largo del tratamiento, se desea estimar la curva de supervivencia para observar la probabilidad de que un paciente continúe a partir de un día determinado en el tratamiento o de manera análoga, qué porción de la cohorte inicial va a continuar bajo tratamiento en un momento específico del mismo.

Así pues, se estima la curva de supervivencia $S(t) = P(T > t)$ usando el estimado de Kaplan-Meier. El resultado se ilustra a continuación:

```{r, warning=F}
#definiendo evento para km
Datosdepurados$evento <- ifelse(Datosdepurados$Status == "Evento", 1, 0)

#Estimando S(t) via kaplan-meier
KM_fit <- survfit(Surv(dias, evento) ~ 1, data = Datosdepurados)

#graficando S(t)

p <- autoplot(KM_fit, type="fill",surv.alpha=0.9, 
         surv.size=1.5,
         conf.int.alpha=0,
         censor.size=0,
         surv.colour="#666666")+ 
  labs(x = "\n Tiempo en el tratamiento (Días) ", 
       y = "Probabilidad de continuar \n", 
       title = "Curva de supervivencia estimada:\n TMO para pacientes con apnea del sueño",
       caption = "Usando el estimador de Kaplan-Meier") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10)) +
  geom_vline(xintercept = c(21,36,57,74,94,121), linetype="dashed", 
             color = "black", size=0.5) +
  xlim(0,125) +
  #ylim(50,100) +
  geom_label(aes(x=21, y = 1, label = "Nivel 1")) +
  geom_label(aes(x=36, y = 1, label = "Nivel 2")) +
  geom_label(aes(x=57, y = 1, label = "Nivel 3")) +
  geom_label(aes(x=74, y = 1, label = "Nivel 4")) +
  geom_label(aes(x=94, y = 1, label = "Nivel 5")) +
  geom_label(aes(x=121, y = 1, label = "Nivel 6")) +
  geom_label(aes(x=20, y = 0.4,
  label = "Probabilidad de que continúe\n a partir del nivel 1 es 84.2%")) +
  geom_segment(aes(x=0, xend=21,y=0.8421349,yend=0.8421349),
               linetype="dashed") +
  geom_segment(aes(x=21,xend=10,y=0.8421349, yend=0.5),
               arrow = arrow(length = unit(0.3,"cm")), size = 1, col = "red")

p
```

En este gráfico se considera que un paciente se va a demorar por nivel lo obtenido en la sección de estadísticos de resúmen, es decir, para el nivel 1 del tratamiento 21 días, para el nivel 2 15 días, para el nivel 3 20 días, para el nivel 4 17 días, para el nivel 5 20 días y para el nivel 6 28 días.

Así entonces, las líneas verticales punteadas demarcan el día esperado para que un paciente termine el nivel correspondiente que se señala en la parte superior.

Dicho esto, se tienen las siguientes conclusiones de interés:

-   Un paciente que termine el nivel 1 del tratamiento tendrá una probabilidad del 84.2% de continuar ea nivel 2 o de manera análoga, se espera que el 84.2% de los pacientes que comienzan el tratamiento continúen al nivel 2.

-   Similarmente, un paciente que termine el nivel 2 del tratamiento tendrá una probabilidad del 68.2% de continuar al nivel 3 o de manera análoga, se espera que el 68.2% de los pacientes que comienzan el tratamiento continúen al nivel 3.

-   De igual forma, un paciente que termine el nivel 3 del tratamiento tendrá una probabilidad del 50.2% de continuar al nivel 4 o de manera análoga, se espera que el 50.2% de los pacientes que comienzan el tratamiento continúen al nivel 4.

-   Así mismo, un paciente que termine el nivel 4 del tratamiento tendrá una probabilidad del 41.2% de continuar al nivel 5 o de manera análoga, se espera que el 41.2% de los pacientes que comienzan el tratamiento continúen al nivel 5.

-   Igualmente, un paciente que termine el nivel 5 del tratamiento tendrá una probabilidad del 34.4% de continuar al nivel 6 o de manera análoga, se espera que el 34.4% de los pacientes que comienzan el tratamiento continúen al nivel 6.

## Diferencia entre grupos de GAP

Una de las dinámicas del tratamiento consiste en programar una cita de control para cada paciente una vez termine uno de los niveles y esté a puertas de comenzar el siguiente; sin embargo estas citas de control en algunas ocasiones suelen programarse en un periodo prolongado, lo que ocasiona una ventana de tiempo considerablemente grande entre niveles del tratamiento. En este caso se considera que una ventana de tiempo mayor a 15 días entre niveles es excesivo e incluso posiblemente perjudicial para los efectos del tratamiento.

Con lo anterior se crea naturalmente el cuestionamiento: ¿Un GAP (ventana) de tiempo excesivo (mayor a quince días) entre niveles ocasiona que los pacientes bajo tratamiento se adhieran menos al mismo?

Para dar respuesta a esta pregunta se clasifican los pacientes de acuerdo a si en algún momento de su tratamiento tuvieron al menos un GAP de tiempo mayor a quince días en algún momento. Habitualemnte se crean dos grupos: Aquellos que tuvieron sus citas de control en menos de quince días (GAP $\leq$ 15) y aquellos que en algún momento del tratamiento tuvieron un tiempo de espera prolongado entre niveles del mismo (GAP \> 15). Así pues, para apreciar la adherencia de ambos grupos se grafican sus respectivas curvas de supervivencia como sigue.

```{r, warning=FALSE, fig.width=8.5}
KM_fit_2 <- survfit(Surv(dias, evento) ~ GAP, data = Datosdepurados)

p2 <- autoplot(KM_fit_2, type="fill",surv.alpha=0.9, 
               surv.size=2,
               conf.int.alpha=0.2,
               censor.size=5,
               censor.colour="purple")+ 
  labs(x = "\n Tiempo en el tratamiento (Días) ", 
       y = "Probabilidad de continuar \n", 
       title = "Curva de supervivencia estimada:\n TMO para pacientes con apnea del sueño",
       caption = "Usando el estimador de Kaplan-Meier",
       color = "Tiempo de espera\n entre niveles") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10)) +
  geom_vline(xintercept = c(21,36,57,74,94,121), linetype="dashed", 
             color = "black", size=0.5) +
  xlim(0,125) +
  geom_label(aes(x=21, y = 1, label = "Nivel 1")) +
  geom_label(aes(x=36, y = 1, label = "Nivel 2")) +
  geom_label(aes(x=57, y = 1, label = "Nivel 3")) +
  geom_label(aes(x=74, y = 1, label = "Nivel 4")) +
  geom_label(aes(x=94, y = 1, label = "Nivel 5")) +
  geom_label(aes(x=121, y = 1, label = "Nivel 6")) +
  guides(fill="none")
p2
```

Antes de proceder a concluír sobre estas dos curvas, es necesario demostrar estadísticamente si existe una diferencia significativa entre las mismas.

Veamos entonces si existe una diferencia estadísticamente significativa entre las dos curvas de supervivencia ilustradas anteriormente.

Denote $S_1(t)$: Curva de supervivencia para pacientes que no experimentan un GAP grande de tiempo y $S_2(t)$: Curva de supervivencia para pacientes que en algún momento de su tratamiento tuvieron que esperar más de quince días entre niveles.

Así entonces, mediante la prueba Log-Rank se desea juzgar el siguiente juego de hipótesis

$$
\begin{cases}
H_0: S_1(t) = S_2(t)\\
H_1: S_1(t) \neq S_2(t)
\end{cases}
$$ Con esto, usando un nivel de significancia $\alpha = 0.05$, se obtiene el siguiente resultado

```{r}
km_fit_2_test <- survdiff(Surv(dias, evento) ~ GAP, data = Datosdepurados)

test_res <- data.frame(chi = km_fit_2_test$chisq, p = km_fit_2_test$pvalue)

kable(test_res, caption = "Resultados Prueba Log-Rank", align = "c",
      booktab = T, escape = F, col.names = c("$\\chi^2$", "Valor P"), digits = 4)
```

Teniendo en cuenta que Valor P $<<<$ $\alpha = 0.05$, se puede rechazar $H_0: S_1(t) = S_2(t)$ contundentemente, concluyendo así que la supervivencia entre los dos grupos es significativamente diferente.

Así entonces se pueden realizar las siguientes conclusiones.

-   La supervivencia de los pacientes que en algún momento de su tratamiento experimentan un GAP de tiempo excesivo parece ser superior a la de los pacientes que no tienen que esperar mucho antes de iniciar su siguiente nivel respectivo, es decir, los pacientes que en algún momento deben esperar mucho por una cita de control parecen adherirse mas al tratamiento, resultado completamente contraintuitivo.

-   **Sin embargo, el GAP de tiempo mencionado puede no ser debido exclusivamente al tiempo en que se programa una cita de control. En ocasiones, se puede considerar adecuado que un paciente realice ciertos ejercicios durante un periodo de tiempo antes de comenzar el siguiente nivel, lo cual no es necesariamente negativo, por el contrario puede pensarse que un acompañamiento cercano al paciente lo motiva más y hace que el mismo mejore sus probabilidades de terminar exitosamente el tratamiento.**

-   Si bien los pacientes que experimentan un GAP grande de tiempo parecen adherirse más al tratamiento, hay que concluír con cuidado en este aspecto, porque el tiempo prolongado en la programación de estas citas de control pueden estar inflando falsamente la supervivencia de un paciente que más adelante no va a continuar con su tratamiento.

## ¿Realmente sobreviven más los pacientes con GAP grande?

```{r}
proportions <- table(Datosdepurados$Status, Datosdepurados$GAP) %>% 
  prop.table(margin = 2) %>% as.data.frame() %>% mutate(Status = ifelse(Var1=="Evento",
                                                                        "Abandonó",
                                                                        "Continuó"),
                                                        GAP = Var2, 
                                                        Proportion = Freq) %>%
  select(GAP, Proportion, Status)

gapplot <- ggplot(proportions, aes(x = GAP, y = Proportion, fill = Status)) + 
  geom_bar(stat = "identity", position=position_dodge()) +
  geom_text(aes(label=Proportion %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "Tiempo (GAP) entre niveles", 
       y = "Proporción", 
       title = "Proporción de pacientes que abandonaron de acuerdo al GAP",
       fill = "Condición") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10)) 
gapplot
```

Note que de acuerdo a este gráfico, para los pacientes que no experimentan un tiempo de espera mayor a quince días entre sus niveles, el 83% de los mismos abandonaron el tratamientos. Sin embargo, para aquellos pacientes que en algún momento del tratamiento tuvieron que esperar más de quince días para iniciar un nuevo nivel, esta proporción es menor, pues en este caso, solo el 59% abandonó el tratamiento.

\newpage

## Análisis descriptivo: Pacientes que llegaron a la meta

Se dispone de una base de datos que contiene información relacionada a 126 pacientes que completaron el tratamiento miofuncional orofacial (TMO) en todos sus niveles. En dicha base de datos se encuentra consignada información relacionada a comorbilidades, condiciones oclusales, diversos índices, edad, sexo etc. de cada uno de los pacientes que completaron el tratamiento. La estructura de la base de datos así como algunas variables se ilustran en la siguiente tabla:

```{r}
Datos130 <- read_excel("Datos130Adecuada.xlsx")%>% 
  filter(`ESQUEMA NIVEL 1` == "TMO NIVEL 1")

kable(head(Datos130[c(2,3,4,9,8)]), caption = "Estructura de los datos", align = "c",
      booktab = T, escape = F, digits = 4)
```

En este ejemplo, la variable "PuntGeneral" es una escala continua de 1-5 que indica el nivel de satisfacción/efectividad del tratamiento del paciente, donde 1 indica un paciente que considera inefectivo el tratamiento y 5 indica que el paciente considera el tratamiento absolutamente efectivo.

### Variables esquema, sexo, edad e IMC

Así entonces, para dar inicio al análisis descriptivo, se plantean los siguientes gráficos:

```{r}
plot1 <- ggplot(prop.table(table(Datos130$SEXO)) %>% as.data.frame(), aes(x = Var1, y = Freq)) + 
  geom_bar(stat = "identity", fill = "darkgreen") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "Sexo", 
       y = "Proporción", 
       title = "Proporción de pacientes por sexo") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10)) 
plot2 <- ggplot(Datos130, aes(x = EDAD)) +
  geom_density(color="darkblue", fill="lightblue") + 
  labs(x = "Edad", 
       y = "Densidad", 
       title = "Concentración de la edad de los pacientes") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10)) +
  scale_x_continuous(breaks = seq(15,80,5), limits = c(15,80))

plot3 <- ggplot(Datos130, aes(x = IMC)) +
  geom_density(color="darkred", fill="red") + 
  labs(x = "IMC", 
       y = "Densidad", 
       title = "Concentración del IMC") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
ggarrange(plot1,plot2,plot3)
```
Según estos gráficos se tienen las siguientes apreciaciones:

- El 61% de los pacientes son femeninos, diferencia significativa con la muestra masculina.

- En general, el rango de edad de los pacientes del tratamiento es de los 18 a 75 años, y según el gráfico, hay una concentración destacable de pacientes entre los 30 y 40 años, sin embargo la concentración más apreciable de pacientes se encuentra entre los 50 y 60 años de edad. 

- De manera similar, el índice de masa corporal centra usualmente sus valores alrededor del 25, sin embargo se puede notar una pequeña moda alrededor del 32 que podría indicar un porción considerable de pacientes en el rango de la obesidad.

### Análisis escala Epworth

Para lo que respecta a la escala de Epworth, observe el siguiente gráfico:

```{r}
plot4 <- ggplot(data.frame(X1 = c(rep("Salida", 87), rep("Basal",87)),
                  X2 = c(Datos130$`EPWORTH SALIDA`, Datos130$`EPWORTH BASAL`)), 
       aes(y = X2, fill = X1)) + geom_boxplot() +
  labs(x = "", 
       y = "Resultado", 
       title = "Resultado Epworth Basal vs. Salida",
       fill = "Momento") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

plot4
```

- De este boxplot se puede apreciar que existe una diferencia aparente en el resultado de la escala de somnolencia entre el momento de entrada y salida de un paciente al tratamiento. En general puede decirse que una vez concluído el tratamiento, los pacientes se autoperciben menos somnolientos respecto al momento de entrada a la terapia miofuncional orofacial.

\newpage

### Síntomas reportados

Ahora, en relación a los síntomas que reportan los pacientes al momento de la terapia, observe los siguientes gráficos:

```{r, fig.height=3}
plot5 <- ggplot(prop.table(table(Datos130$`SINTOMA PRINCIPAL`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Síntoma Principal",
       fill = "Síntoma") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())
plot5
```

- De este gráfico se aprecia que en este caso, el 29% de los pacientes definieron el ronquido como su síntoma principal. Otro síntoma destacable en este caso es la dificultad para mantener el sueño, puesto el 16% de las veces como síntoma principal.

\newpage

### Tipo de examen de sueño

Observe ahora el siguiente gráfico en relación al tipo de examen de sueño

```{r}
plot6 <- ggplot(prop.table(table(Datos130$`TIPO EXAMEN DE SUEÑO`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción por tipo de examen",
       fill = "Tipo") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot6
```

- La mayoría de pacientes que ingresan al tratamiento se les practica una Polisomnografía como examen del sueño, abarcando el 83% de los casos.

\newpage

### Índices y variables numéricas

Se plantean ahora los siguientes gráficos relativos a índices y variables numéricas

```{r, fig.height=8}
plot7 <- ggplot(Datos130, aes(x = `IAH BASAL`)) +
  geom_density(color="orange", fill="darkorange") + 
  labs(x = "", 
       y = "Densidad", 
       title = "IAH Basal") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
plot8 <- ggplot(Datos130, aes(x = `INDICE DE RONQUIDO/h`)) +
  geom_density(color="orange", fill="darkorange") + 
  labs(x = "", 
       y = "Densidad", 
       title = "Indice de Ronquido/h") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
plot9 <- ggplot(Datos130, aes(x = `% SpO2`)) +
  geom_density(color="orange", fill="darkorange") + 
  labs(x = "", 
       y = "Densidad", 
       title = "% SpO2") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))

plot10 <- ggplot(Datos130, aes(x = `MÍNIMAS DE O2`)) +
  geom_density(color="orange", fill="darkorange") + 
  labs(x = "", 
       y = "Densidad", 
       title = "Minimas de o2") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))

plot11 <- ggplot(Datos130, aes(x = `T 90`)) +
  geom_density(color="orange", fill="darkorange") + 
  labs(x = "", 
       y = "Densidad", 
       title = "T 90") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))

ggarrange(plot7,plot8,plot9,plot10,plot11, ncol = 2, nrow = 3)
```
De este conjunto de gráficos se aprecia lo siguiente:

- Los valores más usuales para el índice de apneas hipoapneas de sueño se centran alrededor de 10. La gran mayoría de los pacientes registran este índice entre los valores de 0 y 20; sin embargo existen pacientes que tienen registros más altos llegando al caso extremo de un paciente que registra un índice de 66.3 apneas hipoapneas de sueño.

- La curva de densidad para el índice de ronquido se nota un poco más extendida sobre su rango, donde un poco menos de la mitad de los pacientes registran menos de 100 en este índice de ronquido. Nuevamente se aprecia una cola hacia la derecha de la distribución muestral de esta variable, lo que indica presencia de valores extremos por encima de 500.

- Los porcentajes de SpO2 varían entre 0.84 y 0.96, centrando sus valores (usuales) en el 92%. La mayoría de pacientes en este aspecto registran entre 90% y 94% de saturación promedio por horas de sueño grabadas durante el examen; sin ebargo existe una ligera cola a la izquierda de esta dsitribución que indica valores por debajo del 88% que resultan atípicos según el comportamiento normal de esta variable.

- Una situación similar se aprecia cuando se observa la curva de las mínimas de o2. En este punto los valores se concentran entre 0.75 y 0.90. Sin embargo y de manera análoga al gráfico anterior, en esta distribución se aprecia una cola a la izquiera lo que indica la presencia de valores extremos y atípicamente pequeños.

- Finalmente, en lo que respecta al porcentaje de tiempo en el que la saturación de oxigeno estuvo por debajo de 90% por el total de horas de sueño grabadas, se puede apreciar que los valores se concentran a la izquierda del 25%, siendo los porcentajes más pequeños los más usuales. Sin embargo se aprecia que existen valores grandes que extienden la distribución hasta un 100%.

### Relativo a vías aereas superiores

En relación a las vías aereas superiores, se plantean los siguientes gráficos:

```{r}
plot12 <- ggplot(prop.table(table(unlist(strsplit(Datos130$`CUAL (ES)`, ", ")))) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción por procedimiento quirúrgico",
       fill = "Tipo") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot13 <- ggplot(prop.table(table(Datos130$OVAS)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con OVAS",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot12
plot13
```

- Del primer gráfico se abserva que, el 74% de los pacientes no ha tenido una cirugía en sus vías aéreas superiores. El 11% ha tenido una Amigdalectomía, el 9% una Turbinoplastia y el 5% una Septoplastia. 

- Del segundo se concluye que el 63% de los pacientes no poseen obstrucciones de la vía aérea superior.

\newpage

### Condiciones relacionadas a la cavidad oral

En los siguientes gráficos se analizan algunas condiciones relacionadas a la cavidad oral de los pacientes:

```{r}
plot14 <- ggplot(prop.table(table(Datos130$`LENG RETRAÍDA`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nLengua Retraída",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot15 <- ggplot(prop.table(table(Datos130$`UVULA ALARGADA`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nUvula Alargada",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot16 <- ggplot(prop.table(table(Datos130$`VELO DESCENDIDO`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nVelo Descendido",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot17 <- ggplot(prop.table(table(Datos130$`PILARES ERITEMATOSOS`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nPilares Eritematosos",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

ggarrange(plot14,plot15,plot16,plot17)
```

- Del primero se nota que el 68% de los pacientes que terminaron su tratamiento poseen la condición de lengua retraída.

- Similarmente, el 84% de los pacientes poseen una uvula alargada, mientras que en un 8% de las personas no se logra concluír sobre esta condición.

- Igualmente, en lo que al velo descendido respecta, se observa que el 94% de los pacientes del tratamiento tienen esta condición.

- De manera casi idéntica, el 95% de los pacientes registra pilares eritematosos.

¿Existe entonces una relación entre las últimas dos condiciones? Véase la siguiente tabla:

```{r}
kable(table(Datos130$`VELO DESCENDIDO`, Datos130$`PILARES ERITEMATOSOS`), caption = "VELO DESCENDIDO VS PILARES ERITEMATOSOS", align = "c",
      booktab = T, escape = F, digits = 4)
```

De esta tabla se aprecia que prácticamente todos los pacientes que poseen velo descendido, poseen además pilares eritematosos; sin embargo, para probar esta cuestión de manera formal, se plantea el siguiente juego de hipótesis:

$$
\begin{cases}
H_0: \text{Las condiciones velo descendido y pilares eritematosos no están relacionadas}\\
H_1: \text{Las condiciones velo descendido y pilares eritematosos están relacionadas}
\end{cases}
$$
Para juzgar este juego de hipótesis se plantea el test $\chi^2$ de Pearson para independencia de tablas de contingencia. Los resultados son como sigue:

```{r}
chisqtest <- chisq.test(table(Datos130$`VELO DESCENDIDO`, Datos130$`PILARES ERITEMATOSOS`))

chisqtest_res <- data.frame(chi = chisqtest$statistic, 
                            df = chisqtest$parameter, 
                            p = "1.5E-7")

kable(chisqtest_res, caption = "Resultados Prueba de Independencia", align = "c",
      booktab = T, escape = F, col.names = c("$\\chi^2$","DF", "Valor P"), digits = 4,
      row.names = F)
```

De acuerdo a este resultado y usando cualquier nivel de significancia ($\alpha$) usual, se rechaza la hipótesis nula ($H_0$) concluyendo de este modo que existe una relación estadísticamente significativa entre las condiciones bucales "velo descendido" y "pilares eritematosos" de los pacientes en cuestión.

### Comorbilidades

Para tener una perspectiva de las comorbilidades entre los pacientes del tratamiento, se plantean los siguientes gráficos:

```{r}
plot18 <- ggplot(prop.table(table(Datos130$CO_Cardiovasculares)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \ncomorbilidades cardiovasculares",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot19 <- ggplot(prop.table(table(Datos130$CO_Endocrino_metabólicas)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \ncomorbilidades endocrino-metabólicas",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot20 <- ggplot(prop.table(table(Datos130$CO_Psiquiátricas)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \ncomorbilidades psiquiátricas",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot21 <- ggplot(prop.table(table(Datos130$CO_Pulmonares)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \ncomorbilidades pulmonares",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

ggarrange(plot18,plot19,plot20,plot21)
```

- De este conjunto de gráficos se aprecia que, las comorbilidades más usuales entre los pacientes en el tratamiento son las comorbilidades cardiovasculares y las endocrino-metabólicas, esta última presente en casi la mitad de los pacientes. 

- La proporción de pacientes con comorbilidades psiquiátricas o pulmonares es baja, con 10% y 20% de los pacientes respectivamente.

### Mordida

De manera similar, para tener una perspectiva de las condiciones en la mordida de los pacientes se plantea el siguiente conjunto de gráficos:

```{r, fig.height=8}
plot22 <- ggplot(prop.table(table(Datos130$Línea_media_desviada)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nlínea media desviada",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot23 <- ggplot(prop.table(table(Datos130$Mordida_borde_a_borde)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nmordida borde a borde",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot24 <- ggplot(prop.table(table(Datos130$Mordida_abierta_anterior)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nmordida abierta anterior",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot25 <- ggplot(prop.table(table(Datos130$Mordida_cruzada)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nmordida cruzada",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot26 <- ggplot(prop.table(table(Datos130$Maloclusión_clase_II)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nmaloclusión clase II",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

plot27 <- ggplot(prop.table(table(Datos130$Maloclusión_clase_III)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Proporción de pacientes con \nmaloclusión clase III",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())

ggarrange(plot22,plot23,plot24,plot25,plot26,plot27, ncol=2,nrow=3)
```

- De las condiciones en la mordida de los pacientes bajo tratamiento, la línea media desviada es la más frecuente con un 63% de los pacientes que la poseen.

- Condiciones como mordida borde aborde y mordida cruzada son poco usuales entre los pacientes. En todos los casos, menos del 10% de los pacientes tuvieron alguna de estas condiciones.

- El 18% y 11% de los pacientes reportaron maloclusión clase II y maloclusión clase III respectivamente.

### Maniobras de bostezo y fonema

Ahora, para visualizar el resultado de las maniobras de bostezo y fonema para los pacientes que completaron el tratamiento, se exponen los siguientes gráficos:

```{r}
plot28 <- ggplot(prop.table(table(Datos130$`MAN BOSTEZO - VELO`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Resultados de Maniobra Bostezo - Velo",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())
plot28
```

- De este gráfico se puede apreciar que el 79% de los pacientes ascienden el velo en la maniobra de bostezo, con un 51% para aquellos que lo hacen de forma reducida, y un 28% para aquellos que en la maniobra de bostezo ascienden el velo totalmente. Un 16% de los pacientes poseen un dorso lingual lo suficientemente alto para impedir la conclusión en esta maniobra. 


```{r}
plot29 <- ggplot(prop.table(table(Datos130$`MAN BOSTEZO - ÚVULA`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Resultados de Maniobra Bostezo - Úvula",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())
plot29
```

- Continuando con la misma maniobra pero observando la úvula, en el gráfico se logra apreciar que 1/4 de los pacientes no contrae la úvula en la maniobra de bostezo, proporción análoga a aquellos pacientes que si la contraen durante la maniobra. En este caso la mayoría de los pacientes poseen un dorso lingual lo suficientemente alto para que el resultado no sea concluyente, sin embargo la diferencia con los demás grupos es reducida.


```{r}
plot30 <- ggplot(prop.table(table(Datos130$`MAN. FONEMA - VELO`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Resultados de Maniobra Fonema - Velo",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())
plot30
```

- Pasando a la maniobra de fonema, según el gráfico se puede observa que un 66% de los pacientes asciende el velo de manera reducida en esta prueba. En este caso los pacientes que no ascienden el velo son minoría con un 8% y los demás grupos empatan sus proporciones con cerca de un 14%.


```{r}
plot31 <- ggplot(prop.table(table(Datos130$`MAN FONEMA - ÚVULA`)) %>% as.data.frame(), aes(x = Var1, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=Freq %>% round(2)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+ 
  labs(x = "", 
       y = "Proporción", 
       title = "Resultados de Maniobra Fonema - Úvula",
       fill = "") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10),
        axis.text.x = element_blank())
plot31
```

- Finalmente, observando la úvula en la maniobra de fonema, se puede notar que una mayoría de los pacientes no la contraen en este ejercicio con un 32% del total de los participantes. Es destacable en este caso que hay una gran proporción (32%) de pacientes con un dorso lingual tan alto como para no observar el resultado de la práctica. 

## Continuación: Variable respuesta vs. regresores

Como se comentó en el principio del análisis descriptivo, la variable "PuntGeneral" es una escala continua de 1-5 que indica el nivel de satisfacción/efectividad del tratamiento del paciente, donde 1 indica un paciente que considera inefectivo el tratamiento y 5 indica que el paciente considera el tratamiento absolutamente efectivo.

Esta variable configura en sí misma un indicador de desempeño del tratamiento, y es de interés central poder determinar cuáles son los factores que afectan la percepción del paciente en relación a la efectividad del tratamiento. Por esta razón, en haras de una etapa de modelamiento predictivo posterior, se realiza un análisis descriptivo en relación a la puntuación general que asignan los pacientes de acuerdo al éxito del tratamiento.

```{r, eval = F}
ggplot(Datos130, aes(x = `T 90`, y = PuntGeneral)) + geom_point() +
  labs(x = "", 
       y = "Resultado", 
       title = "Resultado Epworth Basal vs. Salida",
       fill = "Momento") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
```

